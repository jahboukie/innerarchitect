{% extends 'base.html' %}

{% block title %}Practice Reminders - The Inner Architect{% endblock %}

{% block content %}
<div class="container my-5">
    <div class="row">
        <div class="col-lg-10 mx-auto">
            <!-- Introduction -->
            <div class="card shadow-sm border-0 rounded-4 mb-4">
                <div class="card-body p-4">
                    <h2 class="card-title mb-3">Practice Reminders</h2>
                    
                    <p class="lead">
                        Create personalized reminders to maintain consistency in your practice of NLP techniques.
                    </p>
                    
                    <div class="card border-0 p-3 mb-4" style="background: var(--subtle-gradient);">
                        <div class="d-flex">
                            <div class="feature-icon flex-shrink-0 me-3" style="margin: 0; width: 48px; height: 48px;">
                                <i class="fas fa-lightbulb"></i>
                            </div>
                            <div>
                                <p class="mb-0">
                                    Consistency is key to developing new communication habits. Set up reminders for regular practice
                                    of techniques and exercises that you find most valuable.
                                </p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="d-flex justify-content-between align-items-center mt-4">
                        <button id="create-reminder-btn" class="btn btn-primary rounded-pill">
                            <i class="fas fa-plus-circle me-2"></i>Create New Reminder
                        </button>
                        
                        <div class="btn-group" role="group">
                            <button id="check-due-btn" class="btn btn-outline-secondary rounded-pill me-2">
                                <i class="fas fa-bell me-2"></i>Check Due Reminders
                            </button>
                            <button id="refresh-reminders-btn" class="btn btn-outline-secondary rounded-pill">
                                <i class="fas fa-sync me-2"></i>Refresh
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Reminders Statistics -->
            <div class="card shadow-sm border-0 rounded-4 mb-4">
                <div class="card-body p-4">
                    <h3 class="card-title mb-3">Your Practice Stats</h3>
                    
                    <div class="row g-4">
                        <div class="col-md-3">
                            <div class="card text-center h-100 border-0 p-3 practice-stats-card" style="background: var(--subtle-gradient);">
                                <div class="feature-icon mx-auto mb-2" style="width: 48px; height: 48px;">
                                    <i class="fas fa-tasks"></i>
                                </div>
                                <h4 class="text-info" id="total-reminders">0</h4>
                                <p class="mb-0">Total Reminders</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card text-center h-100 border-0 p-3 practice-stats-card" style="background: var(--subtle-gradient);">
                                <div class="feature-icon mx-auto mb-2" style="width: 48px; height: 48px;">
                                    <i class="fas fa-bell"></i>
                                </div>
                                <h4 class="text-info" id="active-reminders">0</h4>
                                <p class="mb-0">Active Reminders</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card text-center h-100 border-0 p-3 practice-stats-card" style="background: var(--subtle-gradient);">
                                <div class="feature-icon mx-auto mb-2" style="width: 48px; height: 48px;">
                                    <i class="fas fa-chart-line"></i>
                                </div>
                                <h4 class="text-info" id="completion-rate">0%</h4>
                                <p class="mb-0">Completion Rate</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card text-center h-100 border-0 p-3 practice-stats-card" style="background: var(--subtle-gradient);">
                                <div class="feature-icon mx-auto mb-2" style="width: 48px; height: 48px;">
                                    <i class="fas fa-fire"></i>
                                </div>
                                <h4 class="text-info" id="longest-streak">0</h4>
                                <p class="mb-0">Longest Streak</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Active Reminders -->
            <div class="d-flex align-items-center mb-3">
                <h3 class="mb-0 me-auto">Active Reminders</h3>
                <button id="refresh-reminders-btn-alt" class="btn btn-sm btn-outline-secondary rounded-pill ms-2">
                    <i class="fas fa-sync me-1"></i>Refresh
                </button>
            </div>
            
            <div id="reminders-container">
                <div class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
            
            <div id="empty-reminders" class="card border-0 p-4 text-center d-none mb-4" style="background: var(--subtle-gradient);">
                <div class="feature-icon mx-auto mb-3" style="width: 64px; height: 64px;">
                    <i class="fas fa-bell-slash"></i>
                </div>
                <p class="mb-3">You don't have any active reminders. Create a new one to get started!</p>
                <div>
                    <button id="create-empty-reminder-btn" class="btn btn-primary rounded-pill">
                        <i class="fas fa-plus-circle me-2"></i>Create New Reminder
                    </button>
                </div>
            </div>
            
            <!-- Create Reminder Modal -->
            <div class="modal fade" id="createReminderModal" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header border-0">
                            <h5 class="modal-title">Create Practice Reminder</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <form id="create-reminder-form">
                                <div class="mb-3">
                                    <label for="reminder-title" class="form-label">Reminder Title<span class="text-danger">*</span></label>
                                    <input type="text" class="form-control rounded-3" id="reminder-title" required>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="reminder-description" class="form-label">Description</label>
                                    <textarea class="form-control rounded-3" id="reminder-description" rows="2"></textarea>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="reminder-type" class="form-label">Reminder Type<span class="text-danger">*</span></label>
                                            <select class="form-select rounded-3" id="reminder-type" required>
                                                <option value="" selected disabled>Select a type</option>
                                                <!-- Options will be added by JavaScript -->
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="reminder-frequency" class="form-label">Frequency<span class="text-danger">*</span></label>
                                            <select class="form-select rounded-3" id="reminder-frequency" required>
                                                <option value="" selected disabled>Select a frequency</option>
                                                <!-- Options will be added by JavaScript -->
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="mb-3" id="days-of-week-container">
                                    <label class="form-label">Days of Week</label>
                                    <div class="d-flex flex-wrap gap-2">
                                        <div class="form-check">
                                            <input class="form-check-input day-checkbox" type="checkbox" value="0" id="day-0">
                                            <label class="form-check-label" for="day-0">Monday</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input day-checkbox" type="checkbox" value="1" id="day-1">
                                            <label class="form-check-label" for="day-1">Tuesday</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input day-checkbox" type="checkbox" value="2" id="day-2">
                                            <label class="form-check-label" for="day-2">Wednesday</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input day-checkbox" type="checkbox" value="3" id="day-3">
                                            <label class="form-check-label" for="day-3">Thursday</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input day-checkbox" type="checkbox" value="4" id="day-4">
                                            <label class="form-check-label" for="day-4">Friday</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input day-checkbox" type="checkbox" value="5" id="day-5">
                                            <label class="form-check-label" for="day-5">Saturday</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input day-checkbox" type="checkbox" value="6" id="day-6">
                                            <label class="form-check-label" for="day-6">Sunday</label>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">Preferred Times</label>
                                    <div class="d-flex flex-wrap gap-2" id="time-preferences-container">
                                        <div class="form-check">
                                            <input class="form-check-input time-checkbox" type="checkbox" value="8" id="time-8">
                                            <label class="form-check-label" for="time-8">8:00 AM</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input time-checkbox" type="checkbox" value="12" id="time-12">
                                            <label class="form-check-label" for="time-12">12:00 PM</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input time-checkbox" type="checkbox" value="18" id="time-18">
                                            <label class="form-check-label" for="time-18">6:00 PM</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input time-checkbox" type="checkbox" value="21" id="time-21">
                                            <label class="form-check-label" for="time-21">9:00 PM</label>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="mb-3" id="linked-content-container">
                                    <label for="linked-content" class="form-label">Link to Content (Optional)</label>
                                    <select class="form-select rounded-3" id="linked-content">
                                        <option value="" selected>No linked content</option>
                                        <optgroup label="Techniques">
                                            <option value="reframing">Reframing</option>
                                            <option value="anchoring">Anchoring</option>
                                            <option value="pattern_interruption">Pattern Interruption</option>
                                            <option value="future_pacing">Future Pacing</option>
                                            <option value="sensory_language">Sensory Language</option>
                                            <option value="meta_model">Meta Model</option>
                                        </optgroup>
                                        <optgroup label="Voice Exercises">
                                            <option value="voice_ex_1">Mirroring Exercise</option>
                                            <option value="voice_ex_2">Reframing Exercise</option>
                                            <option value="voice_ex_3">Sensory Language Exercise</option>
                                        </optgroup>
                                    </select>
                                </div>
                                
                                <div class="card border-0 p-3 mb-0 small" style="background: var(--subtle-gradient);">
                                    <div class="d-flex">
                                        <div class="feature-icon flex-shrink-0 me-2" style="margin: 0; width: 24px; height: 24px;">
                                            <i class="fas fa-info-circle"></i>
                                        </div>
                                        <div>
                                            Browser notifications will appear at the selected times when you're using the application.
                                            For more consistent reminders, consider enabling desktop notifications.
                                        </div>
                                    </div>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer border-0">
                            <button type="button" class="btn btn-outline-secondary rounded-pill" data-bs-dismiss="modal">Cancel</button>
                            <button type="button" class="btn btn-primary rounded-pill" id="save-reminder-btn">Create Reminder</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Due Reminders Modal -->
            <div class="modal fade" id="dueRemindersModal" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header border-0">
                            <h5 class="modal-title">Due Reminders</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <div id="due-reminders-container">
                                <!-- Due reminders will be added here by JavaScript -->
                            </div>
                            
                            <div id="no-due-reminders" class="card border-0 p-4 text-center d-none" style="background: var(--subtle-gradient);">
                                <div class="feature-icon mx-auto mb-3" style="width: 48px; height: 48px;">
                                    <i class="fas fa-check-circle"></i>
                                </div>
                                <p class="mb-0">You don't have any due reminders at this time.</p>
                            </div>
                        </div>
                        <div class="modal-footer border-0">
                            <button type="button" class="btn btn-outline-secondary rounded-pill" data-bs-dismiss="modal">Close</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Delete Confirmation Modal -->
            <div class="modal fade" id="deleteReminderModal" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header border-0">
                            <h5 class="modal-title">Delete Reminder</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <p>Are you sure you want to delete this reminder?</p>
                            <p id="delete-reminder-title" class="fw-bold"></p>
                        </div>
                        <div class="modal-footer border-0">
                            <button type="button" class="btn btn-outline-secondary rounded-pill" data-bs-dismiss="modal">Cancel</button>
                            <button type="button" class="btn btn-danger rounded-pill" id="confirm-delete-btn">Delete</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Global variables
        let remindersData = [];
        let currentDeleteReminderId = null;
        
        // Elements
        const createReminderBtn = document.getElementById('create-reminder-btn');
        const checkDueBtn = document.getElementById('check-due-btn');
        const refreshRemindersBtn = document.getElementById('refresh-reminders-btn');
        const remindersContainer = document.getElementById('reminders-container');
        const emptyReminders = document.getElementById('empty-reminders');
        const createReminderModal = new bootstrap.Modal(document.getElementById('createReminderModal'));
        const dueRemindersModal = new bootstrap.Modal(document.getElementById('dueRemindersModal'));
        const deleteReminderModal = new bootstrap.Modal(document.getElementById('deleteReminderModal'));
        const createReminderForm = document.getElementById('create-reminder-form');
        const saveReminderBtn = document.getElementById('save-reminder-btn');
        const reminderTypeSelect = document.getElementById('reminder-type');
        const reminderFrequencySelect = document.getElementById('reminder-frequency');
        const daysOfWeekContainer = document.getElementById('days-of-week-container');
        const dueRemindersContainer = document.getElementById('due-reminders-container');
        const noDueReminders = document.getElementById('no-due-reminders');
        const deleteReminderTitle = document.getElementById('delete-reminder-title');
        const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
        
        // DOM elements for statistics
        const totalRemindersEl = document.getElementById('total-reminders');
        const activeRemindersEl = document.getElementById('active-reminders');
        const completionRateEl = document.getElementById('completion-rate');
        const longestStreakEl = document.getElementById('longest-streak');
        
        // Load reminder types
        function loadReminderTypes() {
            fetch('/api/reminders/types')
                .then(response => response.json())
                .then(data => {
                    // Clear existing options (except the placeholder)
                    reminderTypeSelect.innerHTML = '<option value="" selected disabled>Select a type</option>';
                    
                    // Add new options
                    Object.entries(data.types).forEach(([typeId, typeName]) => {
                        const option = document.createElement('option');
                        option.value = typeId;
                        option.textContent = typeName;
                        reminderTypeSelect.appendChild(option);
                    });
                })
                .catch(error => {
                    console.error('Error loading reminder types:', error);
                });
        }
        
        // Load reminder frequencies
        function loadReminderFrequencies() {
            fetch('/api/reminders/frequencies')
                .then(response => response.json())
                .then(data => {
                    // Clear existing options (except the placeholder)
                    reminderFrequencySelect.innerHTML = '<option value="" selected disabled>Select a frequency</option>';
                    
                    // Add new options
                    Object.entries(data.frequencies).forEach(([freqId, freqName]) => {
                        const option = document.createElement('option');
                        option.value = freqId;
                        option.textContent = freqName;
                        reminderFrequencySelect.appendChild(option);
                    });
                })
                .catch(error => {
                    console.error('Error loading reminder frequencies:', error);
                });
        }
        
        // Update days of week visibility based on frequency
        function updateDaysOfWeekVisibility() {
            const frequency = reminderFrequencySelect.value;
            
            if (frequency === 'daily') {
                daysOfWeekContainer.classList.add('d-none');
                
                // Check all days
                document.querySelectorAll('.day-checkbox').forEach(checkbox => {
                    checkbox.checked = true;
                });
            } else {
                daysOfWeekContainer.classList.remove('d-none');
                
                // Set default selections based on frequency
                if (frequency === 'every_other_day') {
                    setSelectedDays([0, 2, 4, 6]);  // Mon, Wed, Fri, Sun
                } else if (frequency === 'twice_weekly') {
                    setSelectedDays([1, 4]);  // Tue, Fri
                } else if (frequency === 'weekly') {
                    setSelectedDays([0]);  // Monday
                } else {
                    // Clear all
                    document.querySelectorAll('.day-checkbox').forEach(checkbox => {
                        checkbox.checked = false;
                    });
                }
            }
        }
        
        // Set selected days checkboxes
        function setSelectedDays(days) {
            // Clear all first
            document.querySelectorAll('.day-checkbox').forEach(checkbox => {
                checkbox.checked = false;
            });
            
            // Then select the specified days
            days.forEach(day => {
                const checkbox = document.getElementById(`day-${day}`);
                if (checkbox) {
                    checkbox.checked = true;
                }
            });
        }
        
        // Load reminders
        function loadReminders() {
            remindersContainer.innerHTML = `
                <div class="text-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            `;
            
            fetch('/api/reminders')
                .then(response => response.json())
                .then(data => {
                    remindersData = data.reminders;
                    renderReminders();
                })
                .catch(error => {
                    console.error('Error loading reminders:', error);
                    remindersContainer.innerHTML = `
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            Failed to load reminders. Please try refreshing the page.
                        </div>
                    `;
                });
        }
        
        // Render reminders
        function renderReminders() {
            if (remindersData.length === 0) {
                remindersContainer.innerHTML = '';
                emptyReminders.classList.remove('d-none');
                return;
            }
            
            emptyReminders.classList.add('d-none');
            remindersContainer.innerHTML = '';
            
            // Sort reminders by next notification time
            remindersData.sort((a, b) => {
                if (!a.next_notification) return 1;
                if (!b.next_notification) return -1;
                return new Date(a.next_notification) - new Date(b.next_notification);
            });
            
            remindersData.forEach(reminder => {
                const reminderCard = document.createElement('div');
                reminderCard.className = 'card bg-dark shadow-sm border-0 rounded-3 mb-3';
                
                // Format next notification time
                let nextNotificationText = 'Not scheduled';
                if (reminder.next_notification) {
                    const nextDate = new Date(reminder.next_notification);
                    nextNotificationText = nextDate.toLocaleString();
                }
                
                // Create card content
                reminderCard.innerHTML = `
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-9">
                                <h4 class="card-title">${reminder.title}</h4>
                                <p class="text-muted mb-2">${reminder.description || 'No description'}</p>
                                
                                <div class="d-flex flex-wrap gap-3 mb-3">
                                    <span class="badge bg-primary-subtle text-primary-emphasis px-2 py-1">
                                        <i class="fas fa-tag me-1"></i> ${reminder.reminder_type_display}
                                    </span>
                                    <span class="badge bg-primary-subtle text-primary-emphasis px-2 py-1">
                                        <i class="fas fa-calendar me-1"></i> ${reminder.frequency_display}
                                    </span>
                                    <span class="badge bg-primary-subtle text-primary-emphasis px-2 py-1">
                                        <i class="fas fa-clock me-1"></i> ${reminder.time_preferences_formatted.join(', ')}
                                    </span>
                                    <span class="badge bg-primary-subtle text-primary-emphasis px-2 py-1">
                                        <i class="fas fa-calendar-day me-1"></i> ${reminder.days_of_week_formatted}
                                    </span>
                                </div>
                                
                                <div class="small text-muted">
                                    <div><strong>Next reminder:</strong> ${nextNotificationText}</div>
                                    <div><strong>Streak:</strong> ${reminder.streak || 0} completions</div>
                                </div>
                            </div>
                            
                            <div class="col-md-3 d-flex flex-column justify-content-between align-items-end">
                                <div class="form-check form-switch">
                                    <input class="form-check-input reminder-active-toggle" type="checkbox" role="switch" 
                                        id="active-toggle-${reminder.reminder_id}" 
                                        data-reminder-id="${reminder.reminder_id}" 
                                        ${reminder.active ? 'checked' : ''}>
                                    <label class="form-check-label" for="active-toggle-${reminder.reminder_id}">
                                        ${reminder.active ? 'Active' : 'Inactive'}
                                    </label>
                                </div>
                                
                                <div class="btn-group mt-3">
                                    ${reminder.linked_content_id ? `
                                        <a href="${getContentUrl(reminder.linked_content_id, reminder.linked_content_type)}" 
                                           class="btn btn-sm btn-outline-primary me-2">
                                            <i class="fas fa-external-link-alt me-1"></i> Open Content
                                        </a>
                                    ` : ''}
                                    <button class="btn btn-sm btn-outline-danger delete-reminder-btn" 
                                        data-reminder-id="${reminder.reminder_id}" 
                                        data-reminder-title="${reminder.title}">
                                        <i class="fas fa-trash-alt me-1"></i> Delete
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                remindersContainer.appendChild(reminderCard);
            });
            
            // Add event listeners to active toggles
            document.querySelectorAll('.reminder-active-toggle').forEach(toggle => {
                toggle.addEventListener('change', function() {
                    const reminderId = this.dataset.reminderId;
                    const active = this.checked;
                    
                    // Update label
                    const label = this.nextElementSibling;
                    label.textContent = active ? 'Active' : 'Inactive';
                    
                    // Update in API
                    updateReminderActive(reminderId, active);
                });
            });
            
            // Add event listeners to delete buttons
            document.querySelectorAll('.delete-reminder-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const reminderId = this.dataset.reminderId;
                    const reminderTitle = this.dataset.reminderTitle;
                    
                    // Set values for delete confirmation
                    currentDeleteReminderId = reminderId;
                    deleteReminderTitle.textContent = reminderTitle;
                    
                    // Show delete confirmation modal
                    deleteReminderModal.show();
                });
            });
        }
        
        // Update reminder active status
        function updateReminderActive(reminderId, active) {
            fetch(`/api/reminders/${reminderId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    active: active
                })
            })
            .then(response => response.json())
            .then(data => {
                if (!data.success) {
                    console.error('Error updating reminder:', data.error);
                    
                    // Reload reminders to get current state
                    loadReminders();
                }
            })
            .catch(error => {
                console.error('Error updating reminder:', error);
                
                // Reload reminders to get current state
                loadReminders();
            });
        }
        
        // Get content URL based on ID and type
        function getContentUrl(contentId, contentType) {
            if (!contentId) return '#';
            
            if (contentType === 'technique') {
                return `/techniques/${contentId}`;
            } else if (contentType === 'voice_exercise') {
                return `/voice-practice/${contentId}`;
            } else if (contentType === 'nlp_exercise') {
                return `/exercises/${contentId}`;
            } else if (contentType === 'journey') {
                return `/personalized-journeys/${contentId}`;
            }
            
            return '#';
        }
        
        // Load due reminders
        function loadDueReminders() {
            dueRemindersContainer.innerHTML = `
                <div class="text-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            `;
            
            noDueReminders.classList.add('d-none');
            
            fetch('/api/reminders/due')
                .then(response => response.json())
                .then(data => {
                    if (data.reminders.length === 0) {
                        dueRemindersContainer.innerHTML = '';
                        noDueReminders.classList.remove('d-none');
                        return;
                    }
                    
                    dueRemindersContainer.innerHTML = '';
                    
                    data.reminders.forEach(reminder => {
                        const reminderItem = document.createElement('div');
                        reminderItem.className = 'card bg-dark mb-3 border-0';
                        
                        reminderItem.innerHTML = `
                            <div class="card-body">
                                <h5 class="card-title">${reminder.title}</h5>
                                <p class="text-muted mb-2">${reminder.description || 'No description'}</p>
                                
                                <div class="d-flex justify-content-between align-items-center mt-3">
                                    ${reminder.linked_content_id ? `
                                        <a href="${getContentUrl(reminder.linked_content_id, reminder.linked_content_type)}" 
                                           class="btn btn-sm btn-primary">
                                            <i class="fas fa-external-link-alt me-1"></i> Open Content
                                        </a>
                                    ` : '<div></div>'}
                                    
                                    <button class="btn btn-sm btn-success complete-reminder-btn" 
                                        data-reminder-id="${reminder.reminder_id}">
                                        <i class="fas fa-check me-1"></i> Mark Complete
                                    </button>
                                </div>
                            </div>
                        `;
                        
                        dueRemindersContainer.appendChild(reminderItem);
                    });
                    
                    // Add event listeners to complete buttons
                    document.querySelectorAll('.complete-reminder-btn').forEach(button => {
                        button.addEventListener('click', function() {
                            const reminderId = this.dataset.reminderId;
                            markReminderComplete(reminderId, this);
                        });
                    });
                })
                .catch(error => {
                    console.error('Error loading due reminders:', error);
                    dueRemindersContainer.innerHTML = `
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            Failed to load due reminders. Please try again.
                        </div>
                    `;
                });
        }
        
        // Mark reminder as complete
        function markReminderComplete(reminderId, buttonEl) {
            buttonEl.disabled = true;
            buttonEl.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Completing...';
            
            fetch(`/api/reminders/${reminderId}/complete`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Remove the completed reminder from the list
                    const reminderItem = buttonEl.closest('.card');
                    reminderItem.remove();
                    
                    // Check if any reminders left
                    if (dueRemindersContainer.children.length === 0) {
                        noDueReminders.classList.remove('d-none');
                    }
                    
                    // Reload reminders and statistics
                    loadReminders();
                    loadStatistics();
                } else {
                    buttonEl.disabled = false;
                    buttonEl.innerHTML = '<i class="fas fa-check me-1"></i> Mark Complete';
                    console.error('Error completing reminder:', data.error);
                }
            })
            .catch(error => {
                buttonEl.disabled = false;
                buttonEl.innerHTML = '<i class="fas fa-check me-1"></i> Mark Complete';
                console.error('Error completing reminder:', error);
            });
        }
        
        // Load reminder statistics
        function loadStatistics() {
            fetch('/api/reminders/statistics')
                .then(response => response.json())
                .then(data => {
                    totalRemindersEl.textContent = data.total_reminders;
                    activeRemindersEl.textContent = data.active_reminders;
                    completionRateEl.textContent = `${Math.round(data.completion_rate * 100)}%`;
                    longestStreakEl.textContent = data.longest_streak;
                })
                .catch(error => {
                    console.error('Error loading reminder statistics:', error);
                });
        }
        
        // Create new reminder
        function createNewReminder() {
            // Gather form data
            const title = document.getElementById('reminder-title').value;
            const description = document.getElementById('reminder-description').value;
            const reminderType = reminderTypeSelect.value;
            const frequency = reminderFrequencySelect.value;
            
            // Get selected days of week
            const daysOfWeek = [];
            document.querySelectorAll('.day-checkbox:checked').forEach(checkbox => {
                daysOfWeek.push(parseInt(checkbox.value));
            });
            
            // Get selected time preferences
            const timePreferences = [];
            document.querySelectorAll('.time-checkbox:checked').forEach(checkbox => {
                timePreferences.push(parseInt(checkbox.value));
            });
            
            // Get linked content
            const linkedContent = document.getElementById('linked-content').value;
            
            // Validate form
            if (!title || !reminderType || !frequency) {
                alert('Please fill in all required fields.');
                return;
            }
            
            if (daysOfWeek.length === 0 && frequency !== 'daily') {
                alert('Please select at least one day of the week.');
                return;
            }
            
            if (timePreferences.length === 0) {
                alert('Please select at least one time preference.');
                return;
            }
            
            // Disable save button
            saveReminderBtn.disabled = true;
            saveReminderBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Creating...';
            
            // Create reminder via API
            fetch('/api/reminders', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    title: title,
                    description: description,
                    reminder_type: reminderType,
                    frequency: frequency,
                    days_of_week: daysOfWeek,
                    time_preferences: timePreferences,
                    linked_content_id: linkedContent || null
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Reset form
                    createReminderForm.reset();
                    
                    // Hide modal
                    createReminderModal.hide();
                    
                    // Reload reminders
                    loadReminders();
                    loadStatistics();
                } else {
                    alert('Error creating reminder: ' + (data.error || 'Unknown error'));
                }
                
                // Re-enable save button
                saveReminderBtn.disabled = false;
                saveReminderBtn.innerHTML = 'Create Reminder';
            })
            .catch(error => {
                console.error('Error creating reminder:', error);
                alert('An error occurred while creating the reminder.');
                
                // Re-enable save button
                saveReminderBtn.disabled = false;
                saveReminderBtn.innerHTML = 'Create Reminder';
            });
        }
        
        // Delete reminder
        function deleteReminder(reminderId) {
            fetch(`/api/reminders/${reminderId}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Reload reminders
                    loadReminders();
                    loadStatistics();
                } else {
                    alert('Error deleting reminder: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Error deleting reminder:', error);
                alert('An error occurred while deleting the reminder.');
            });
        }
        
        // Event listeners
        createReminderBtn.addEventListener('click', function() {
            // Reset form
            createReminderForm.reset();
            
            // Load dropdowns
            loadReminderTypes();
            loadReminderFrequencies();
            
            // Show modal
            createReminderModal.show();
        });
        
        checkDueBtn.addEventListener('click', function() {
            loadDueReminders();
            dueRemindersModal.show();
        });
        
        refreshRemindersBtn.addEventListener('click', function() {
            loadReminders();
            loadStatistics();
        });
        
        reminderFrequencySelect.addEventListener('change', updateDaysOfWeekVisibility);
        
        saveReminderBtn.addEventListener('click', createNewReminder);
        
        confirmDeleteBtn.addEventListener('click', function() {
            if (currentDeleteReminderId) {
                deleteReminder(currentDeleteReminderId);
                deleteReminderModal.hide();
            }
        });
        
        // Initialize
        loadReminders();
        loadStatistics();
        
        // Request notification permission
        if ('Notification' in window) {
            if (Notification.permission !== 'granted' && Notification.permission !== 'denied') {
                Notification.requestPermission();
            }
        }
    });
</script>
{% endblock %}