{% extends 'base.html' %}

{% block title %}Belief Change Protocol - The Inner Architect{% endblock %}

{% block content %}
<div class="container my-5">
    <div class="row">
        <div class="col-lg-10 mx-auto">
            <!-- Introduction Section -->
            <div class="card shadow-sm border-0 rounded-4 mb-4">
                <div class="card-body p-4">
                    <h2 class="card-title">Belief Change Protocol</h2>
                    
                    <p class="lead mb-4">
                        Transform limiting beliefs into empowering perspectives using this structured NLP approach.
                    </p>
                    
                    <div class="row g-4 mb-4">
                        <div class="col-md-6">
                            <div class="card h-100 border-0 p-3" style="background: var(--subtle-gradient);">
                                <div class="d-flex">
                                    <div class="feature-icon flex-shrink-0 me-3" style="margin: 0; width: 48px; height: 48px;">
                                        <i class="fas fa-lightbulb"></i>
                                    </div>
                                    <div>
                                        <h5 class="card-title">What are Limiting Beliefs?</h5>
                                        <p class="card-text">
                                            Limiting beliefs are thoughts or perceptions that constrain your potential or prevent you from taking positive action. They often contain words like "can't," "never," "always," or "impossible."
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card h-100 border-0 p-3" style="background: var(--subtle-gradient);">
                                <div class="d-flex">
                                    <div class="feature-icon flex-shrink-0 me-3" style="margin: 0; width: 48px; height: 48px;">
                                        <i class="fas fa-rocket"></i>
                                    </div>
                                    <div>
                                        <h5 class="card-title">Why Change Them?</h5>
                                        <p class="card-text">
                                            Transforming these beliefs opens new possibilities for growth, reduces anxiety and self-doubt, and empowers you to take action aligned with your true potential and goals.
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card border-0 rounded-3 mb-4" style="background: linear-gradient(to right, rgba(230, 242, 255, 0.2), rgba(230, 242, 255, 0.1));">
                        <div class="card-body">
                            <div class="d-flex">
                                <div class="feature-icon flex-shrink-0 me-3" style="margin: 0; width: 48px; height: 48px;">
                                    <i class="fas fa-info-circle"></i>
                                </div>
                                <div>
                                    <p class="mb-0">
                                        <strong>The Protocol Process:</strong> This 7-step process guides you through identifying a limiting belief, examining its foundation, challenging it, creating an empowering alternative, and implementing action steps to reinforce the new perspective.
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="d-grid gap-2 d-md-flex justify-content-md-start">
                        <button id="start-new-session-btn" class="btn btn-primary rounded-pill">
                            <i class="fas fa-plus-circle me-2"></i>Start a New Protocol Session
                        </button>
                        <button id="view-past-sessions-btn" class="btn btn-outline-secondary rounded-pill">
                            <i class="fas fa-history me-2"></i>View Past Sessions
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Protocol Steps Overview -->
            <div class="card shadow-sm border-0 rounded-4 mb-4">
                <div class="card-body p-4">
                    <h3 class="card-title mb-4">The 7-Step Protocol</h3>
                    
                    <div class="protocol-steps-timeline">
                        <div class="timeline-item" data-step="identify">
                            <div class="timeline-dot bg-primary">1</div>
                            <div class="timeline-content" style="background: var(--subtle-gradient); border-radius: 0.5rem; padding: 1rem;">
                                <h5>Identify Limiting Belief</h5>
                                <p class="mb-0">Recognize and articulate a belief that is holding you back.</p>
                            </div>
                        </div>
                        
                        <div class="timeline-item" data-step="evidence">
                            <div class="timeline-dot bg-primary">2</div>
                            <div class="timeline-content" style="background: var(--subtle-gradient); border-radius: 0.5rem; padding: 1rem;">
                                <h5>Examine Supporting Evidence</h5>
                                <p class="mb-0">Explore what experiences or messages have reinforced this belief.</p>
                            </div>
                        </div>
                        
                        <div class="timeline-item" data-step="challenge">
                            <div class="timeline-dot bg-primary">3</div>
                            <div class="timeline-content" style="background: var(--subtle-gradient); border-radius: 0.5rem; padding: 1rem;">
                                <h5>Challenge the Belief</h5>
                                <p class="mb-0">Question the validity and usefulness of the belief.</p>
                            </div>
                        </div>
                        
                        <div class="timeline-item" data-step="alternative">
                            <div class="timeline-dot bg-primary">4</div>
                            <div class="timeline-content" style="background: var(--subtle-gradient); border-radius: 0.5rem; padding: 1rem;">
                                <h5>Create Empowering Alternative</h5>
                                <p class="mb-0">Develop a new belief that better serves your goals.</p>
                            </div>
                        </div>
                        
                        <div class="timeline-item" data-step="evidence_new">
                            <div class="timeline-dot bg-primary">5</div>
                            <div class="timeline-content" style="background: var(--subtle-gradient); border-radius: 0.5rem; padding: 1rem;">
                                <h5>Find Supporting Evidence</h5>
                                <p class="mb-0">Identify experiences that support your new empowering belief.</p>
                            </div>
                        </div>
                        
                        <div class="timeline-item" data-step="embodiment">
                            <div class="timeline-dot bg-primary">6</div>
                            <div class="timeline-content" style="background: var(--subtle-gradient); border-radius: 0.5rem; padding: 1rem;">
                                <h5>Embody New Belief</h5>
                                <p class="mb-0">Experience how this new belief feels in your body and mind.</p>
                            </div>
                        </div>
                        
                        <div class="timeline-item" data-step="action">
                            <div class="timeline-dot bg-primary">7</div>
                            <div class="timeline-content" style="background: var(--subtle-gradient); border-radius: 0.5rem; padding: 1rem;">
                                <h5>Take Aligned Action</h5>
                                <p class="mb-0">Plan specific actions that align with your new belief.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Belief Categories Section -->
            <div class="card shadow-sm border-0 rounded-4 mb-4">
                <div class="card-body p-4">
                    <h3 class="card-title mb-4">Common Categories of Limiting Beliefs</h3>
                    
                    <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4" id="belief-categories-container">
                        <!-- Categories will be added here by JavaScript -->
                        <div class="col">
                            <div class="card h-100 border-0" style="background: var(--subtle-gradient);">
                                <div class="card-body">
                                    <h5 class="card-title">Self-Image & Identity</h5>
                                    <p class="card-text">Beliefs about who you are and your inherent traits.</p>
                                    <p class="small text-muted fst-italic">"I'm not a creative person."</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col">
                            <div class="card h-100 border-0" style="background: var(--subtle-gradient);">
                                <div class="card-body">
                                    <h5 class="card-title">Abilities & Skills</h5>
                                    <p class="card-text">Beliefs about what you can or cannot do.</p>
                                    <p class="small text-muted fst-italic">"I can't learn new technologies."</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col">
                            <div class="card h-100 border-0" style="background: var(--subtle-gradient);">
                                <div class="card-body">
                                    <h5 class="card-title">Possibilities & Opportunities</h5>
                                    <p class="card-text">Beliefs about what is possible or impossible for you.</p>
                                    <p class="small text-muted fst-italic">"It's impossible to change careers at my age."</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col">
                            <div class="card h-100 border-0" style="background: var(--subtle-gradient);">
                                <div class="card-body">
                                    <h5 class="card-title">Worthiness & Deservingness</h5>
                                    <p class="card-text">Beliefs about your value and what you deserve.</p>
                                    <p class="small text-muted fst-italic">"I don't deserve success or recognition."</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col">
                            <div class="card h-100 border-0" style="background: var(--subtle-gradient);">
                                <div class="card-body">
                                    <h5 class="card-title">Relationships & Connection</h5>
                                    <p class="card-text">Beliefs about how you relate to others.</p>
                                    <p class="small text-muted fst-italic">"People always let me down eventually."</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col">
                            <div class="card h-100 border-0" style="background: var(--subtle-gradient);">
                                <div class="card-body">
                                    <h5 class="card-title">World & Environment</h5>
                                    <p class="card-text">Beliefs about how the world works.</p>
                                    <p class="small text-muted fst-italic">"The world is too competitive for fairness."</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- NLP Techniques Section -->
            <div class="card shadow-sm border-0 rounded-4 mb-4">
                <div class="card-body p-4">
                    <h3 class="card-title mb-4">NLP Techniques Used in the Protocol</h3>
                    
                    <div class="accordion" id="techniquesAccordion">
                        <div class="accordion-item border-0 mb-3" style="background: var(--subtle-gradient); border-radius: 0.5rem;">
                            <h2 class="accordion-header" id="headingReframing">
                                <button class="accordion-button collapsed border-0" style="background: var(--subtle-gradient); border-radius: 0.5rem;" type="button" data-bs-toggle="collapse" data-bs-target="#collapseReframing" aria-expanded="false" aria-controls="collapseReframing">
                                    <strong>Cognitive Reframing</strong>
                                </button>
                            </h2>
                            <div id="collapseReframing" class="accordion-collapse collapse" aria-labelledby="headingReframing" data-bs-parent="#techniquesAccordion">
                                <div class="accordion-body">
                                    <p><strong>Description:</strong> Changing the perspective or context to give a situation a different meaning.</p>
                                    <p><strong>Application:</strong> Used in the "Challenge the Belief" and "Create Empowering Alternative" steps.</p>
                                    <p class="mb-0"><strong>Example:</strong> Reframing "I failed" to "I learned what doesn't work" shifts from a fixed judgment to a growth perspective.</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="accordion-item border-0 mb-3" style="background: var(--subtle-gradient); border-radius: 0.5rem;">
                            <h2 class="accordion-header" id="headingPattern">
                                <button class="accordion-button collapsed border-0" style="background: var(--subtle-gradient); border-radius: 0.5rem;" type="button" data-bs-toggle="collapse" data-bs-target="#collapsePattern" aria-expanded="false" aria-controls="collapsePattern">
                                    <strong>Pattern Interruption</strong>
                                </button>
                            </h2>
                            <div id="collapsePattern" class="accordion-collapse collapse" aria-labelledby="headingPattern" data-bs-parent="#techniquesAccordion">
                                <div class="accordion-body">
                                    <p><strong>Description:</strong> Breaking habitual thought patterns to create space for new perspectives.</p>
                                    <p><strong>Application:</strong> Used throughout the process to disrupt automatic limiting thoughts.</p>
                                    <p class="mb-0"><strong>Example:</strong> When you catch yourself thinking the limiting belief, deliberately switching to an unrelated positive thought or physical movement.</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="accordion-item border-0 mb-3" style="background: var(--subtle-gradient); border-radius: 0.5rem;">
                            <h2 class="accordion-header" id="headingFuturePacing">
                                <button class="accordion-button collapsed border-0" style="background: var(--subtle-gradient); border-radius: 0.5rem;" type="button" data-bs-toggle="collapse" data-bs-target="#collapseFuturePacing" aria-expanded="false" aria-controls="collapseFuturePacing">
                                    <strong>Future Pacing</strong>
                                </button>
                            </h2>
                            <div id="collapseFuturePacing" class="accordion-collapse collapse" aria-labelledby="headingFuturePacing" data-bs-parent="#techniquesAccordion">
                                <div class="accordion-body">
                                    <p><strong>Description:</strong> Mentally rehearsing future scenarios with the new belief in place.</p>
                                    <p><strong>Application:</strong> Used in the "Embody New Belief" step to reinforce the new mental model.</p>
                                    <p class="mb-0"><strong>Example:</strong> Vividly imagining yourself in a future situation responding confidently with your new belief, feeling the emotions and sensations associated with it.</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="accordion-item border-0 mb-3" style="background: var(--subtle-gradient); border-radius: 0.5rem;">
                            <h2 class="accordion-header" id="headingAnchoring">
                                <button class="accordion-button collapsed border-0" style="background: var(--subtle-gradient); border-radius: 0.5rem;" type="button" data-bs-toggle="collapse" data-bs-target="#collapseAnchoring" aria-expanded="false" aria-controls="collapseAnchoring">
                                    <strong>Anchoring</strong>
                                </button>
                            </h2>
                            <div id="collapseAnchoring" class="accordion-collapse collapse" aria-labelledby="headingAnchoring" data-bs-parent="#techniquesAccordion">
                                <div class="accordion-body">
                                    <p><strong>Description:</strong> Associating the new belief with a physical trigger to reinforce it.</p>
                                    <p><strong>Application:</strong> Used in the "Embody New Belief" step to create a physical reminder.</p>
                                    <p class="mb-0"><strong>Example:</strong> Touching your thumb and forefinger together while strongly experiencing your new empowering belief, then using this gesture to recall the belief when needed.</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="accordion-item border-0 mb-3" style="background: var(--subtle-gradient); border-radius: 0.5rem;">
                            <h2 class="accordion-header" id="headingMetaModel">
                                <button class="accordion-button collapsed border-0" style="background: var(--subtle-gradient); border-radius: 0.5rem;" type="button" data-bs-toggle="collapse" data-bs-target="#collapseMetaModel" aria-expanded="false" aria-controls="collapseMetaModel">
                                    <strong>Meta Model Questioning</strong>
                                </button>
                            </h2>
                            <div id="collapseMetaModel" class="accordion-collapse collapse" aria-labelledby="headingMetaModel" data-bs-parent="#techniquesAccordion">
                                <div class="accordion-body">
                                    <p><strong>Description:</strong> Using precise questioning to challenge generalizations, deletions, and distortions.</p>
                                    <p><strong>Application:</strong> Used in the "Examine Supporting Evidence" and "Challenge the Belief" steps.</p>
                                    <p class="mb-0"><strong>Example:</strong> For the belief "I always fail at important tasks," asking "Always? Have there been any exceptions at all?" challenges the universal quantifier.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Past Sessions Section -->
            <div class="card shadow-sm border-0 rounded-4 mb-4" id="past-sessions-card" style="display: none;">
                <div class="card-body p-4">
                    <h3 class="card-title mb-4">Your Past Protocol Sessions</h3>
                    
                    <div id="sessions-container">
                        <div class="text-center py-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    </div>
                    
                    <div id="no-sessions-message" class="card border-0 p-4 text-center" style="display: none; background: var(--subtle-gradient);">
                        <div class="feature-icon mx-auto mb-3" style="width: 48px; height: 48px;">
                            <i class="fas fa-info-circle"></i>
                        </div>
                        <p class="mb-0">You haven't started any belief change protocol sessions yet. Click "Start a New Protocol Session" to begin.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- New Session Modal -->
<div class="modal fade" id="newSessionModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header border-0">
                <h5 class="modal-title">Start New Belief Change Session</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="new-session-form">
                    <div class="mb-3">
                        <label for="limiting-belief" class="form-label">What limiting belief would you like to transform?</label>
                        <textarea class="form-control" id="limiting-belief" rows="3" placeholder="Example: I'm not good enough to apply for that promotion."></textarea>
                        <div class="form-text">Be specific and honest. Write the belief exactly as it appears in your mind.</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="belief-category" class="form-label">Category (Optional)</label>
                        <select class="form-select" id="belief-category">
                            <option value="" selected>Auto-detect category</option>
                            <option value="self">Self-Image & Identity</option>
                            <option value="capability">Abilities & Skills</option>
                            <option value="possibility">Possibilities & Opportunities</option>
                            <option value="worth">Worthiness & Deservingness</option>
                            <option value="relationships">Relationships & Connection</option>
                            <option value="world">World & Environment</option>
                        </select>
                        <div class="form-text">We can analyze and suggest a category, or you can select one yourself.</div>
                    </div>
                    
                    <div class="form-check mb-4">
                        <input class="form-check-input" type="checkbox" id="analyze-belief-check" checked>
                        <label class="form-check-label" for="analyze-belief-check">
                            Analyze this belief with AI to identify patterns and suggested approaches
                        </label>
                    </div>
                    
                    <div id="belief-analysis-loading" style="display: none;">
                        <div class="d-flex align-items-center gap-2 mb-3">
                            <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
                            <span>Analyzing belief...</span>
                        </div>
                    </div>
                    
                    <div id="belief-analysis-results" style="display: none;" class="mb-4">
                        <div class="card bg-dark-subtle border-0">
                            <div class="card-body">
                                <h6 class="card-subtitle mb-2 text-muted">Analysis Results</h6>
                                <div class="mb-2">
                                    <strong>Category:</strong> <span id="analysis-category"></span>
                                </div>
                                <div class="mb-2">
                                    <strong>Thinking Patterns:</strong>
                                    <ul id="analysis-patterns" class="mb-0"></ul>
                                </div>
                                <div class="mb-2">
                                    <strong>Suggested Techniques:</strong>
                                    <ul id="analysis-techniques" class="mb-0"></ul>
                                </div>
                                <div class="mb-2">
                                    <strong>Potential Origin:</strong> <span id="analysis-origin"></span>
                                </div>
                                <div>
                                    <strong>Areas Impacted:</strong>
                                    <ul id="analysis-impact" class="mb-0"></ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="analyze-belief-btn">Analyze Belief</button>
                <button type="button" class="btn btn-success" id="create-session-btn" style="display: none;">Start Protocol</button>
            </div>
        </div>
    </div>
</div>

<!-- CSS for steps timeline -->
<style>
    .protocol-steps-timeline {
        position: relative;
        margin: 0 0 0 20px;
    }
    
    .protocol-steps-timeline::before {
        content: '';
        position: absolute;
        top: 0;
        bottom: 0;
        left: 20px;
        width: 2px;
        background-color: rgba(255, 255, 255, 0.1);
        z-index: 1;
    }
    
    .timeline-item {
        position: relative;
        padding-left: 60px;
        margin-bottom: 30px;
    }
    
    .timeline-item:last-child {
        margin-bottom: 0;
    }
    
    .timeline-dot {
        position: absolute;
        left: 0;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
        z-index: 2;
    }
    
    .timeline-content {
        background-color: rgba(255, 255, 255, 0.05);
        padding: 15px;
        border-radius: 8px;
    }
    
    .timeline-content h5 {
        margin-top: 0;
        color: var(--bs-primary);
    }
    
    .timeline-content p {
        margin-bottom: 0;
        color: rgba(255, 255, 255, 0.8);
    }
</style>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Elements
        const startNewSessionBtn = document.getElementById('start-new-session-btn');
        const viewPastSessionsBtn = document.getElementById('view-past-sessions-btn');
        const pastSessionsCard = document.getElementById('past-sessions-card');
        const sessionsContainer = document.getElementById('sessions-container');
        const noSessionsMessage = document.getElementById('no-sessions-message');
        
        const newSessionModal = new bootstrap.Modal(document.getElementById('newSessionModal'));
        const limitingBeliefTextarea = document.getElementById('limiting-belief');
        const beliefCategorySelect = document.getElementById('belief-category');
        const analyzeBeliefCheck = document.getElementById('analyze-belief-check');
        const analyzeBeliefBtn = document.getElementById('analyze-belief-btn');
        const createSessionBtn = document.getElementById('create-session-btn');
        
        const beliefAnalysisLoading = document.getElementById('belief-analysis-loading');
        const beliefAnalysisResults = document.getElementById('belief-analysis-results');
        const analysisCategory = document.getElementById('analysis-category');
        const analysisPatterns = document.getElementById('analysis-patterns');
        const analysisTechniques = document.getElementById('analysis-techniques');
        const analysisOrigin = document.getElementById('analysis-origin');
        const analysisImpact = document.getElementById('analysis-impact');
        
        // Event Listeners
        startNewSessionBtn.addEventListener('click', function() {
            // Reset form
            limitingBeliefTextarea.value = '';
            beliefCategorySelect.value = '';
            analyzeBeliefCheck.checked = true;
            resetAnalysisUI();
            
            // Show modal
            newSessionModal.show();
        });
        
        viewPastSessionsBtn.addEventListener('click', function() {
            if (pastSessionsCard.style.display === 'none') {
                pastSessionsCard.style.display = 'block';
                loadPastSessions();
            } else {
                pastSessionsCard.style.display = 'none';
            }
        });
        
        analyzeBeliefBtn.addEventListener('click', function() {
            const beliefText = limitingBeliefTextarea.value.trim();
            
            if (beliefText.length < 5) {
                alert('Please enter a meaningful belief statement (at least 5 characters).');
                return;
            }
            
            analyzeBeliefText(beliefText);
        });
        
        createSessionBtn.addEventListener('click', function() {
            createNewSession();
        });
        
        limitingBeliefTextarea.addEventListener('input', function() {
            if (this.value.trim().length > 0) {
                analyzeBeliefBtn.disabled = false;
            } else {
                analyzeBeliefBtn.disabled = true;
                resetAnalysisUI();
            }
        });
        
        analyzeBeliefCheck.addEventListener('change', function() {
            if (this.checked && limitingBeliefTextarea.value.trim().length > 0) {
                analyzeBeliefBtn.style.display = 'block';
            } else {
                analyzeBeliefBtn.style.display = beliefAnalysisResults.style.display === 'none' ? 'block' : 'none';
                createSessionBtn.style.display = 'block';
            }
        });
        
        // Functions
        function resetAnalysisUI() {
            beliefAnalysisLoading.style.display = 'none';
            beliefAnalysisResults.style.display = 'none';
            analyzeBeliefBtn.style.display = 'block';
            createSessionBtn.style.display = 'none';
            
            analysisCategory.textContent = '';
            analysisPatterns.innerHTML = '';
            analysisTechniques.innerHTML = '';
            analysisOrigin.textContent = '';
            analysisImpact.innerHTML = '';
        }
        
        function analyzeBeliefText(beliefText) {
            if (!analyzeBeliefCheck.checked) {
                createSessionBtn.style.display = 'block';
                return;
            }
            
            // Show loading
            beliefAnalysisLoading.style.display = 'block';
            beliefAnalysisResults.style.display = 'none';
            analyzeBeliefBtn.disabled = true;
            
            // Call API to analyze belief
            fetch('/api/belief-change/analyze', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    belief: beliefText
                })
            })
            .then(response => response.json())
            .then(data => {
                // Hide loading
                beliefAnalysisLoading.style.display = 'none';
                
                if (data.error) {
                    alert('Error analyzing belief: ' + data.error);
                    analyzeBeliefBtn.disabled = false;
                    return;
                }
                
                // Update UI with analysis results
                const analysis = data.analysis;
                
                // Category
                if (analysis.category) {
                    const categoryMap = {
                        'self': 'Self-Image & Identity',
                        'capability': 'Abilities & Skills',
                        'possibility': 'Possibilities & Opportunities',
                        'worth': 'Worthiness & Deservingness',
                        'relationships': 'Relationships & Connection',
                        'world': 'World & Environment'
                    };
                    
                    analysisCategory.textContent = categoryMap[analysis.category] || analysis.category;
                    
                    // Auto-select category in dropdown
                    beliefCategorySelect.value = analysis.category;
                }
                
                // Patterns
                analysisPatterns.innerHTML = '';
                if (analysis.patterns && analysis.patterns.length > 0) {
                    analysis.patterns.forEach(pattern => {
                        const li = document.createElement('li');
                        li.textContent = pattern;
                        analysisPatterns.appendChild(li);
                    });
                }
                
                // Techniques
                analysisTechniques.innerHTML = '';
                if (analysis.suggested_techniques && analysis.suggested_techniques.length > 0) {
                    const techniqueMap = {
                        'reframing': 'Cognitive Reframing',
                        'pattern_interruption': 'Pattern Interruption',
                        'future_pacing': 'Future Pacing',
                        'anchoring': 'Anchoring',
                        'meta_model': 'Meta Model Questioning'
                    };
                    
                    analysis.suggested_techniques.forEach(technique => {
                        const li = document.createElement('li');
                        li.textContent = techniqueMap[technique] || technique;
                        analysisTechniques.appendChild(li);
                    });
                }
                
                // Origin
                if (analysis.potential_origin) {
                    analysisOrigin.textContent = analysis.potential_origin;
                }
                
                // Impact areas
                analysisImpact.innerHTML = '';
                if (analysis.impact_areas && analysis.impact_areas.length > 0) {
                    analysis.impact_areas.forEach(area => {
                        const li = document.createElement('li');
                        li.textContent = area;
                        analysisImpact.appendChild(li);
                    });
                }
                
                // Show results and create button
                beliefAnalysisResults.style.display = 'block';
                analyzeBeliefBtn.style.display = 'none';
                createSessionBtn.style.display = 'block';
            })
            .catch(error => {
                console.error('Error analyzing belief:', error);
                beliefAnalysisLoading.style.display = 'none';
                alert('Failed to analyze belief. Please try again.');
                analyzeBeliefBtn.disabled = false;
            });
        }
        
        function createNewSession() {
            const beliefText = limitingBeliefTextarea.value.trim();
            
            if (beliefText.length < 5) {
                alert('Please enter a meaningful belief statement (at least 5 characters).');
                return;
            }
            
            // Disable button to prevent multiple submissions
            createSessionBtn.disabled = true;
            createSessionBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Creating...';
            
            // Call API to create session
            fetch('/api/belief-change/sessions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    initial_belief: beliefText,
                    category: beliefCategorySelect.value || null
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert('Error creating session: ' + data.error);
                    createSessionBtn.disabled = false;
                    createSessionBtn.textContent = 'Start Protocol';
                    return;
                }
                
                // Redirect to the session page
                window.location.href = '/belief-change/session/' + data.session.belief_session_id;
            })
            .catch(error => {
                console.error('Error creating session:', error);
                alert('Failed to create session. Please try again.');
                createSessionBtn.disabled = false;
                createSessionBtn.textContent = 'Start Protocol';
            });
        }
        
        function loadPastSessions() {
            sessionsContainer.innerHTML = `
                <div class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            `;
            
            fetch('/api/belief-change/sessions')
                .then(response => response.json())
                .then(data => {
                    if (data.sessions && data.sessions.length > 0) {
                        renderPastSessions(data.sessions);
                        noSessionsMessage.style.display = 'none';
                    } else {
                        sessionsContainer.innerHTML = '';
                        noSessionsMessage.style.display = 'block';
                    }
                })
                .catch(error => {
                    console.error('Error loading sessions:', error);
                    sessionsContainer.innerHTML = `
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            Failed to load sessions. Please try refreshing the page.
                        </div>
                    `;
                });
        }
        
        function renderPastSessions(sessions) {
            sessionsContainer.innerHTML = '';
            
            // Sort sessions by creation date (newest first)
            sessions.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
            
            sessions.forEach(session => {
                const sessionCard = document.createElement('div');
                sessionCard.className = 'card bg-dark-subtle border-0 mb-3';
                
                // Format dates
                const createdDate = new Date(session.created_at);
                const createdDateString = createdDate.toLocaleDateString() + ' ' + createdDate.toLocaleTimeString();
                
                const updatedDate = new Date(session.updated_at);
                const updatedDateString = updatedDate.toLocaleDateString() + ' ' + updatedDate.toLocaleTimeString();
                
                sessionCard.innerHTML = `
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <h5 class="card-title mb-0">${truncateText(session.initial_belief || 'Untitled Session', 60)}</h5>
                            <span class="badge ${session.completed ? 'bg-success' : 'bg-primary'} ms-2">
                                ${session.completed ? 'Completed' : 'In Progress'}
                            </span>
                        </div>
                        
                        <div class="mb-3">
                            <div class="progress" style="height: 10px;">
                                <div class="progress-bar ${session.completed ? 'bg-success' : 'bg-primary'}" role="progressbar" 
                                     style="width: ${session.progress_percentage}%;" 
                                     aria-valuenow="${session.progress_percentage}" aria-valuemin="0" aria-valuemax="100"></div>
                            </div>
                            <div class="d-flex justify-content-between mt-1">
                                <small class="text-muted">Progress: ${session.progress_percentage}%</small>
                                <small class="text-muted">Step ${session.current_step_index + 1} of ${session.total_steps}</small>
                            </div>
                        </div>
                        
                        <div class="d-flex flex-wrap gap-2 mb-3">
                            <span class="badge bg-dark text-light p-2">
                                <i class="fas fa-tag me-1"></i> ${session.category_name}
                            </span>
                            <span class="badge bg-dark text-light p-2">
                                <i class="fas fa-calendar me-1"></i> Created: ${createdDateString}
                            </span>
                            <span class="badge bg-dark text-light p-2">
                                <i class="fas fa-clock me-1"></i> Last Updated: ${updatedDateString}
                            </span>
                        </div>
                        
                        <div class="d-flex justify-content-end">
                            <a href="/belief-change/session/${session.belief_session_id}" class="btn btn-primary">
                                ${session.completed ? 'View Completed Session' : 'Continue Session'}
                            </a>
                        </div>
                    </div>
                `;
                
                sessionsContainer.appendChild(sessionCard);
            });
        }
        
        function truncateText(text, maxLength) {
            if (!text) return '';
            return text.length > maxLength ? text.substring(0, maxLength) + '...' : text;
        }
        
        // Initialize UI - analyze button disabled until there is text
        analyzeBeliefBtn.disabled = true;
    });
</script>
{% endblock %}